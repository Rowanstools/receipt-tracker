<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Receipt Tracker</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 2em; }
		.container { max-width: 400px; margin: auto; padding: 2em; border: 1px solid #ccc; border-radius: 8px; }
		label, input, button { display: block; width: 100%; margin-bottom: 1em; }
		#receipt { font-size: 2em; text-align: center; margin-bottom: 1em; }
	</style>
</head>
<body>
	<div class="container">
		<h2>Receipt Tracker</h2>
		<div id="receipt">Loading...</div>
		<form id="claimForm">
			<label for="initials">Your Initials:</label>
			<input type="text" id="initials" maxlength="5" required />
			<button type="submit">Claim Receipt</button>
		</form>
		<div id="message"></div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
  const SUPABASE_URL = 'https://adlnjerrxdunlskyncgo.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkbG5qZXJyeGR1bmxza3luY2dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjU1MjMsImV4cCI6MjA3NDkwMTUyM30.Qps_-Q1oXhZnsAksR-JJBvXTlM_NgV_erp3GYsUsGj8';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function fetchReceipt() {
    const { data, error } = await supabase
      .from('receipts')
      .select('receipt_number')
      .order('receipt_number', { ascending: false })
      .limit(1);

    let nextReceipt = 300000;
    if (data && data.length > 0) {
      nextReceipt = data[0].receipt_number + 1;
    }
    document.getElementById('receipt').textContent = nextReceipt;
  }

  document.getElementById('claimForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const initials = document.getElementById('initials').value.trim();
    if (!initials) return;

    // Get the next receipt number
    const { data } = await supabase
      .from('receipts')
      .select('receipt_number')
      .order('receipt_number', { ascending: false })
      .limit(1);

    let nextReceipt = 300000;
    if (data && data.length > 0) {
      nextReceipt = data[0].receipt_number + 1;
    }

    // Insert the new receipt
    const { error: insertError } = await supabase
      .from('receipts')
      .insert([{ receipt_number: nextReceipt, initials }]);

    if (!insertError) {
      document.getElementById('message').textContent = `Receipt ${nextReceipt} claimed!`;
      fetchReceipt(); // Update immediately for this user
    } else {
      document.getElementById('message').textContent = 'Error claiming receipt.';
    }
    document.getElementById('initials').value = '';
  });

  // Real-time subscription for new receipts (Supabase v2: use .subscribe() and .on())
  const channel = supabase
    .channel('public:receipts')
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'receipts' },
      () => {
        fetchReceipt();
      }
    )
    .subscribe();

  fetchReceipt();
</script>
</body>
</html>
